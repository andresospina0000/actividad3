<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link rel="stylesheet" href="./assets/css/index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@200;400&display=swap" rel="stylesheet">
    <title>Team 8's - Clothing Store</title>
</head>

<header>
    <div>
        <nav class="navbar nav-tabs fixed-top navbarfa-pull-right bg-light" style="background-color: bg-primary">
            <a class="nav-link" id="nav-link" onclick="updateHomeProducts()">Home</a>
            <a class="nav-link" id="nav-link" onclick="showPrdCreationPanel()">Create new products!</a>
            <a class="nav-link" id="nav-link" onclick="showMngPanel()">Update your products!</a>
            <a class="nav-link" id="nav-link" onclick="showAboutUsPanel()">About us</a>
        </nav>
    </div>
    <div class="container">
        <h1>Welcome to Team 8's</h1>
        <h6>Clothing Store</h6>
    </div>
</header>
<br>

<body class="">
    <div id="showProductsPanel" class="container">
        <div id="productsTitle" class="container">
            <h3>Our products</h3>
        </div>
        <div id="productsPanel"></div>
    </div>
    <br>
    <div id="creationPanel" class="container" hidden="true">
        <div class="container">
            <h3>Create New Product</h3>
        </div>
        <div>
            <div id="newPrdForm" class="container">
                <div class="input-group mb-3">
                    <span class="input-group-text" id="basic-addon1">Product Title</span>
                    <input id="newPrdTitle" type="text" class="form-control" placeholder="Product Title"
                        aria-label="Username" aria-describedby="basic-addon1">
                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text">Product price $</span>
                    <input id="newPrdPrice" type="text" class="form-control"
                        aria-label="Amount (to the nearest dollar)">
                    <span class="input-group-text">.00</span>
                </div>
                <div class="input-group">
                    <span class="input-group-text">Product description</span>
                    <textarea id="newPrdDesc" class="form-control" aria-label="With textarea"></textarea>
                </div>
                <div class="mb-3">
                    <label for="formFile" class="form-label">Please choose an image for your product:</label>
                    <input id="newPrdImage" class="form-control" type="file" id="formFile">
                </div>
                <div class="row">
                    <div class="col">
                        <button onclick="previewProduct()" class="btn btn-primary">Product preview...</button>
                    </div>
                    <div class="col">
                        <button onclick="createProductAsync()" class="btn btn-primary">Create Product</button>
                    </div>
                </div>
            </div>
            <br>
            <div id="newPrdPanelPreview" hidden="true">
                <div>
                    <h6>This is how your product will look:</h6>
                </div>
                <div class="card" style="width: 18rem;">
                    <img src="assets/img/sample.jpg" class="card-img-top" alt="...">
                    <div class="card-body">
                        <h5 id="previewPrdName" class="card-title">Product Name</h5>
                        <h5 id="previewPrdPrice" class="card-title">Product Price</h6>
                            <p id="previewDesc" class="card-text">Some quick example text to build on the card title and
                                make up the bulk of
                                the
                                card's content.</p>
                            <a href="#" class="btn btn-primary">Buy</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="productsManagmentPanel" class="container">
        <div id="managmentPanel" class="col">
            <div>
                <h4>Published products:</h4>
            </div>
            <table class="table table-striped table-hover table-bordered border-info">
                <thead>
                    <tr>
                        <th scope="col">Product Id</th>
                        <th scope="col">Title</th>
                        <th scope="col">Price</th>
                        <th scope="col">Image path</th>
                    </tr>
                </thead>
                <tbody id="productsMngTable">

                </tbody>
            </table>
        </div>
        <div class="row">
            <div class="row">
                <h5>Please type the product's id that you want to remove/modify:</h5>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col-3">
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon1">Product Id:</span>
                            <input id="existingPrdId" type="text" class="form-control" placeholder="Product id"
                                aria-label="Username" aria-describedby="basic-addon1">
                        </div>
                        <div>
                            <button onclick="loadExistingProduct()" class="btn btn-primary">Load Product</button>
                        </div>
                    </div>
                    <div class="col-9">
                        <div class="row">
                            <div>
                                <div id="existingPrdForm" class="container">
                                    <fieldset id="existingProductfieldSet" disabled>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text" id="basic-addon1">Product Title</span>
                                            <input id="existingPrdTitle" type="text" class="form-control"
                                                placeholder="Product Title" aria-label="Username"
                                                aria-describedby="basic-addon1">
                                        </div>
                                        <div class="input-group mb-3">
                                            <span class="input-group-text">Product price $</span>
                                            <input id="existingPrdPrice" type="text" class="form-control"
                                                aria-label="Amount (to the nearest dollar)">
                                            <span class="input-group-text">.00</span>
                                        </div>
                                        <div class="input-group">
                                            <span class="input-group-text">Product description</span>
                                            <textarea id="existingPrdDesc" class="form-control"
                                                aria-label="With textarea"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="formFile" class="form-label">Please choose an image for your
                                                product:</label>
                                            <input id="existingPrdImage" class="form-control" type="file" id="formFile">
                                        </div>
                                    </fieldset>
                                    <div class="row">
                                        <div class="col-1">
                                            <button id="cancelModifyPrdBtn" onclick="cancelModification()"
                                                class="btn btn-primary">Cancel</button>
                                        </div>
                                        <div class="col-1">
                                            <button id="modifyPrdBtn" onclick="enableExistingPrdForm()"
                                                class="btn btn-primary">Modify</button>
                                        </div>
                                        <div class="col-1">
                                            <button id="deletePrdBtn" onclick="deleteProduct()"
                                                class="btn btn-danger">Delete</button>
                                        </div>
                                        <div class="col-1">
                                            <button id="saveExistingPrdBtn" onclick="updateProduct()"
                                                class="btn btn-primary" hidden>Save...</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>

    updateHomeProducts()

    //API Integration
    async function getAllProductsAsync() {
        const response = await fetch('http://localhost:4000/api/products');
        const data = await response.json();
        return data;
    }

    async function createProductAsync() {

        const newProduct = getNewProduct();

        if (newProduct) {

            const response = await fetch('http://localhost:4000/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newProduct)
            });

            const data = await response.json();

            if (data.error) {
                alert(data.error);
                return;
            } else {
                new Promise((resolve, reject) => {
                    setTimeout(() => resolve(alert('Product created successfully!')), 10000)
                });
                resetCreationPanel();
            }
        }
    }

    async function getProductByIdAsync(id) {
        const response = await fetch(`http://localhost:4000/api/products/${id}`);
        const data = await response.json();
        return data;
    }

    async function deleteProductByIdAsync(id) {
        const response = await fetch(`http://localhost:4000/api/products/${id}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        if (data.error) {
            alert(data.error);
            return false;
        } else {
            new Promise((resolve, reject) => {
                setTimeout(() => resolve(alert('Product deleted successfully!')), 10000)
            });
            return true;
        }
    }


    async function updateProductAsync(id, product) {

        if (product) {

            const response = await fetch(`http://localhost:4000/api/products/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(product)
            });

            const data = await response.json();
            console.log('updateProductAsync')
            console.log(data);
            if (data.error) {
                alert(data.error);
                return false;
            } else {
                return true;
            }
        }
    }

    //API Integration

    //DOM Manipulation
    function showPrdCreationPanel() {
        document.getElementById('creationPanel').hidden = false;
        document.getElementById('productsManagmentPanel').hidden = true;
        document.getElementById('productsPanel').hidden = true;
        document.getElementById('productsTitle').hidden = true;
        document.getElementById('showProductsPanel').hidden = true;
        document.getElementById('newPrdTitle').value = '';
        document.getElementById('newPrdPrice').value = '';
        document.getElementById('newPrdDesc').value = '';
        document.getElementById('newPrdImage').value = '';
        cleanPreviewPanel();
    }

    function cleanCreationPanel() {
        document.getElementById('newPrdTitle').value = '';
        document.getElementById('newPrdPrice').value = '';
        document.getElementById('newPrdDesc').value = '';
        document.getElementById('newPrdImage').value = '';
    }

    function showProducts() {
        document.getElementById('showProductsPanel').hidden = false;
        document.getElementById('productsPanel').hidden = false;
        document.getElementById('productsTitle').hidden = false;
        document.getElementById('creationPanel').hidden = true;
        document.getElementById('productsManagmentPanel').hidden = true;
    }

    function resetExistingPrdForm() {
        document.getElementById('existingPrdId').value = '';
        document.getElementById('existingPrdTitle').value = '';
        document.getElementById('existingPrdPrice').value = '';
        document.getElementById('existingPrdDesc').value = '';
        document.getElementById('existingPrdImage').value = '';
        document.getElementById('existingPrdForm').hidden = true;
        document.getElementById('existingProductfieldSet').disabled = true;
        document.getElementById('saveExistingPrdBtn').hidden = true;
    }

    async function updateHomeProducts() {

        showProducts();
        let cards = '';
        const productsPanel = document.getElementById('productsPanel');
        productsPanel.innerHTML = '';

        const products = await getAllProductsAsync();

        products.forEach(element => {

            cards = `<div class="p-2 card mb-3" style="width: 18rem;">
                        <img src="${element.image}" class="card-img-top">
                        <div class="card-body">
                            <h5 class="card-title">${element.title}</h5>
                            <h6>$${element.price}</h6>
                            <p class="card-text">${element.description}</p>
                            <a href="#" class="btn btn-primary">Add to cart</a>
                        </div>
                    </div>`;
            productsPanel.insertAdjacentHTML("afterbegin", cards);
        });
    }

    function getNewProduct() {
        const newPrdTitle = document.getElementById('newPrdTitle').value;
        const newPrdPrice = document.getElementById('newPrdPrice').value;
        const newPrdDesc = document.getElementById('newPrdDesc').value;
        const imagePath = document.getElementById('newPrdImage').value + '';
        const splittedPath = imagePath.split('\\');
        const newPrdImage = `assets/img/${splittedPath[splittedPath.length - 1]}`;

        if (!newPrdTitle || !newPrdDesc || !newPrdPrice || !newPrdImage) {
            alert('You must complete all the form! :(')
            return null;
        }

        const newPrd = {
            title: newPrdTitle,
            price: newPrdPrice,
            description: newPrdDesc,
            image: newPrdImage
        }

        return newPrd;
    }

    function previewProduct() {
        const newPrd = getNewProduct();
        if (newPrd) {
            document.getElementById('newPrdPanelPreview').hidden = false;
            document.getElementById('previewPrdName').innerHTML = newPrd.title;
            document.getElementById('previewPrdPrice').innerHTML = `$${newPrd.price}`;
            document.getElementById('previewDesc').innerHTML = newPrd.description;
        }
    }

    function cleanPreviewPanel() {
        document.getElementById('newPrdPanelPreview').hidden = true;
        document.getElementById('previewPrdName').innerHTML = '';
        document.getElementById('previewPrdPrice').innerHTML = '';
        document.getElementById('previewDesc').innerHTML = '';
    }

    function showMngPanel() {
        document.getElementById('existingPrdId').value = '';
        document.getElementById('productsManagmentPanel').hidden = false;
        document.getElementById('productsPanel').hidden = true;
        document.getElementById('productsTitle').hidden = true;
        document.getElementById('creationPanel').hidden = true;
        document.getElementById('newPrdPanelPreview').hidden = true;
        document.getElementById('showProductsPanel').hidden = true;
        document.getElementById('existingPrdForm').hidden = true;
        document.getElementById('previewPrdName').innerHTML = '';
        document.getElementById('previewPrdPrice').innerHTML = '';
        document.getElementById('previewDesc').innerHTML = '';
        loadPublishedProducts();
    }

    function loadPublishedProducts() {
        const productsMngTable = document.getElementById('productsMngTable');
        productsMngTable.innerHTML = '';
        getAllProductsAsync().then(products => {
            products.forEach(element => {
                const row = `<tr>
                                <th scope="row">${element.id}</th>
                                <td>${element.title}</td>
                                <td>${element.price}</td>
                                <td>${element.image}</td>
                            </tr>`;
                productsMngTable.insertAdjacentHTML("afterbegin", row);
            });
        });
    }

    async function deleteProduct() {

        if (confirm('Are you sure you want to delete this product?')) {
            const existingPrdId = document.getElementById('existingPrdId');
            const id = existingPrdId.value;
            const deleted = await deleteProductByIdAsync(id);
            resetExistingPrdForm();
        }
    }

    async function loadExistingProduct() {

        document.getElementById('existingPrdForm').hidden = false;
        const existingPrdId = document.getElementById('existingPrdId');
        const id = existingPrdId.value;

        if (!id) {
            alert('Please type a product id!')
            return null;
        }

        const product = await getProductByIdAsync(id);

        if (product) {
            document.getElementById('existingPrdTitle').value = product.title;
            document.getElementById('existingPrdPrice').value = product.price;
            document.getElementById('existingPrdDesc').value = product.description;
            document.getElementById('existingPrdImage').value = product.image;
            document.getElementById('modifyPrdBtn').hidden = false;
            document.getElementById('deletePrdBtn').hidden = false;
            document.getElementById('saveExistingPrdBtn').hidden = true;
        } else {
            alert('Product not found!');
            resetExistingPrdForm();
        }
    }

    function cancelModification() {
        resetExistingPrdForm();
    }

    function resetCreationPanel() {
        document.getElementById('newPrdTitle').value = '';
        document.getElementById('newPrdPrice').value = '';
        document.getElementById('newPrdDesc').value = '';
        document.getElementById('newPrdImage').value = '';
    }

    function enableExistingPrdForm() {
        document.getElementById('saveExistingPrdBtn').disabled = false;
        document.getElementById('existingProductfieldSet').disabled = false;
        document.getElementById('modifyPrdBtn').hidden = true;
        document.getElementById('deletePrdBtn').hidden = true;
        document.getElementById('saveExistingPrdBtn').hidden = false;
    }

    function updateProduct() {

        const existingPrdId = document.getElementById('existingPrdId').value;
        const existingPrdTitle = document.getElementById('existingPrdTitle').value;
        const existingPrdPrice = document.getElementById('existingPrdPrice').value;
        const existingPrdDesc = document.getElementById('existingPrdDesc').value;
        const existingPrdImage = document.getElementById('existingPrdImage').value;

        const  product = {}

        if(existingPrdId) {
            product['id'] = existingPrdId;
        }
        if(existingPrdTitle) {
            product['title'] = existingPrdTitle;
        }
        if(existingPrdPrice) {
            product['price'] = existingPrdPrice;
        }
        if(existingPrdDesc) {
            product['description'] = existingPrdDesc;
        }
        if(existingPrdImage) {
            product['image'] = existingPrdImage;
        }

        const updated = updateProductAsync(product.id, product);

        if (updated) {
            alert('Product updated successfully!');
            resetExistingPrdForm();
            showMngPanel()
        } else {
            alert('Error updating product!');
        }
    }

    function showAboutUsPanel() {
        alert('By Stephano Palomino y Andres Ospina - Grupo 8 - Three Points - UPC 2023');
    }
    //DOM Manipulation

</script>